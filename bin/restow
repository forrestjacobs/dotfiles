#!/usr/bin/env bash
set -e

if [ -d "${2}" ]; then
  find -L "${2}" -type l -exec rm -- {} +
fi

# Creates softlinks
find "${1}" -type f '!' -name .DS_Store -exec bash -c '
  symlink="$1/${2#*/}"
  target="$(pwd)/${2}"
  if [ ! -L "$symlink" ]; then
    mkdir -p "$(dirname "$target")"
    ln -s "$target" "$symlink"
  elif [ "$(readlink -f $symlink)" != "$target" ]; then
    echo "$symlink already exists and is pointing to something else; exiting"
    exit 1
  fi
' find-bash "${2}" {} ';'
