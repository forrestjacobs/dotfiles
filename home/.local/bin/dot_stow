#!/usr/bin/env bash
set -e

# Creates softlinks
find "${1}" \( -type f -or -type l \) '!' -name .DS_Store -exec bash -c '
  symlink="$1/${2#*/}"
  target="$(pwd)/${2}"
  if [ -f "$symlink" ] && { [ ! -L "$symlink" ] || [ "$(readlink "$symlink")" != "$target" ]; }; then
    readlink "$symlink"
    echo "Moving $symlink to $symlink.old"
    mv "$symlink" "$symlink.old"
  fi
  if [ ! -f "$symlink" ]; then
    mkdir -p "$(dirname "$symlink")"
    ln -s "$target" "$symlink"
  fi
' find-bash "${2}" {} ';'
